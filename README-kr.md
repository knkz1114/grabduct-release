# GrabDuct 사용자 가이드 [한국어]

## GrabDuct란

GrabDuct는 Chrome 브라우저의 탭에서 영상을 캡쳐하여 GPU텍스처로 VJ소프트웨어(Resolume,VDMX,OBS등)에 전송하는 도구입니다. Windows 환경에서는 Spout을 사용하며, macOS 환경에서는 Syphon을 사용한 GPU텍스처 공유를 통해 저지연/고화질 영상 라우팅을 구현합니다.

## 버전 일람

| 컴포넌트 | 버전 |
|---------------|-----------|
| Chrome확장 프로그램 | 0.2.2 |
| 리시버 프로그램 | 0.2.1 |

## 동작 환경

| 항목 | Windows | macOS |
|------|---------|-------|
| OS | Windows 10/11 | macOS 13 (Ventura) 이상 |
| 브라우저 | Chrome / Chromium 116이상 | Chrome / Chromium 116이상 |
| GPU | Direct3D 11을 지원하는 GPU | Metal을 지원하는 GPU |
| 텍스처 출력 | Spout | Syphon |
| 런타임 | GStreamer（설치프로그램에 포함됨） | GStreamer（.app파일에 포함됨） |

## 구성

GrabDuct는 2개의 컴포넌트로 구성되어 있습니다.

1. **Chrome확장 프로그램** -- 브라우저 탭의 영상을 캡처하여 플레이어에 할당합니다.
2. **리시버 프로그램** -- 시스템 트레이/메뉴바에서 동작하는 네이티브 앱으로, WebRTC를 통해 영상을 수신하고 Spout/Syphon 텍스처로 출력합니다.

영상 캡처를 위해서 두 프로그램이 동시에 실행되어 있어야 합니다.

---

## 설정방법

### 1. 리시버 프로그램 설치

#### Windows

GrabDuct 설치 프로그램(`GrabDuctReceiverSetup.exe`)을 실행합니다. 설치 후, 리시버프로그램은 시스템 트레이(알림 영역)에 상주합니다

#### macOS

DMG 파일(`GrabDuctReceiver.dmg`)을 열고, `GrabDuct Receiver.app`을 Applications 폴더로 드래그합니다.

**Gatekeeper 경고에 대한 대처(미서명 빌드인 경우)**

macOS에서는 서명되지 않은 앱을 열려고 하면 “개발자가 확인되지 않아 열 수 없습니다”라는 경고가 표시될 수 있습니다. 다음 중 하나의 방법으로 해결해 주세요.

**방법 1: 오른쪽 클릭으로 열기**

1. Finder에서 `GrabDuct Receiver.app`을 오른쪽 클릭(또는 Control 키와 클릭)
2. 메뉴에서 **열기** 를 선택
3. 확인 대화상자에서 **열기**를 클릭

이 작업은 처음 한 번만 필요합니다. 이후에는 일반적으로 더블 클릭만으로 실행할 수 있습니다.

**방법 2: xattr 명령으로 격리 속성을 삭제**

터미널에서 다음 명령을 실행합니다:

```bash
xattr -cr /Applications/GrabDuct\ Receiver.app
```

`xattr -cr` 이는 macOS가 다운로드한 파일에 부여하는 격리 속성(`com.apple.quarantine`)을 재귀적으로 삭제합니다. 이로 인해 Gatekeeper에 의한 차단이 해제됩니다.

> `-c` 는 모든 확장 속성을 삭제하고, `-r` 은 디렉터리 내부를 재귀적으로 처리하는 옵션입니다.

### 2. Chrome 확장 기능 설치

**ZIP 패키지로 설치하는 경우:**

1. 배포된 `grabduct-extension-vX.Y.Z.zip`을 원하는 폴더에 풀어 넣기
2. Chrome에서 `chrome://extensions/`에 접속
3. 오른쪽 위의 **개발자 모드**를 활성화한다
4. **패키징되지 않은 확장 기능을 불러오기** 를 클릭하고, 풀어 놓은 폴더를 선택
5. 툴바에 GrabDuct 아이콘이 표시된다

**소스에서 직접 로드하는 경우:**

위의 4단계에서 `extension/` 폴더를 선택합니다.

### 3. 리시버 실행

GrabDuct 리시버 프로그램을 실행합니다.

- **Windows**: 시스템 트레이에 아이콘이 표시됩니다. 우클릭으로 메뉴를 엽니다.
- macOS: 메뉴 바에 아이콘이 표시됩니다. 클릭하면 메뉴가 열립니다. Dock에는 아이콘이 표시되지 않습니다.

메뉴 항목:

- **Settings** -- 설정 패널 열기
- **Quit** -- 애플리케이션을 종료한다

### 4. Discord 인증

GrabDuct를 이용하려면 KonaLab Discord 서버에 참여하고 인증을 해야 합니다.

1. 메뉴에서 **Settings**를 선택
2. 로그인 화면에서 **Discord로 로그인**을 클릭
3. 브라우저에서 Discord 인증 페이지가 열립니다
4. 애플리케이션을 승인합니다
5. 인증이 완료되면 메인 화면을 이용할 수 있게 됩니다

---

## 기본적인 사용법

### 탭을 플레이어에 할당하기

1. Chrome에서 영상 콘텐츠가 있는 페이지 를 연다
2. 툴바에 있는 GrabDuct 확장 아이콘을 클릭
3. 팝업에 현재 탭 이름과 최대 4개의 플레이어 슬롯이 표시된다
4. ‘대기 중’이라고 표시된 플레이어 슬롯을 클릭해 현재 탭을 할당한다

캡처가 시작되면 상태창이 초록색으로 바뀝니다.

### 플레이어 슬롯 상태

| 표시 | 상태 | 의미 |
| ------ | ----------- | ------ |
| 회색 점 | 대기 중 | 탭 미배정 |
| 초록 점 | 캡처 중 | 영상 캡처·전송 중 |
| 빨간 점 | 오류 | 캡처 실패(트러블슈팅 참고) |
| 자물쇠 아이콘 | 서포터 전용 | 서포터 플랜이 필요 |

### 탭 할당 해제

‘이 탭’이라고 표시된 플레이어 슬롯을 클릭하면 현재 탭의 할당이 해제됩니다.

### 플레이어 재할당

다른 탭에 이미 할당된 플레이어를 클릭하면 확인 대화창이 표시됩니다. 확인하면 현재 탭에 다시 할당됩니다.

### 리시버 연결 상태

팝업 상단에 연결 상태가 표시됩니다.

- **녹색**（‘리시버 연결 중’） -- 리시버 앱이 실행 중이며 연결 가능
- **빨강**（“리시버 미연결”） -- 리시버 앱이 실행되지 않았거나 응답이 없음

확장 프로그램은 5초마다 연결 상태를 확인합니다.

---

## 리시버 설정

메뉴에서 설정 패널을 엽니다. 세 개의 탭이 있습니다.

### 상태 탭

아래와 같은 정보가 표시됩니다.

- 현재 플랜(Free 또는 Supporter)과 플레이어 수·해상도 상한
- 플레이어별 스테이터스 카드(연결 상태와 해상도)
- 활성 플레이어의 Spout/Syphon 출력 이름(예: `GrabDuct Player 1`)
- 오류 정보

### 설정 탭

#### Discord 인증

- Discord 사용자명과 멤버십 유효 기간을 표시
- **롤 재확인** -- Discord 서버의 멤버십과 서포터 롤을 수동으로 재확인
- **로그아웃** -- Discord에서 로그아웃(로그인 화면으로 돌아가기)

#### 출력 해상도

플레이어별로 출력 해상도를 설정할 수 있습니다. 프리셋은 가로세로 비율별로 구분되어 있습니다.

**16:9**
- 1280x720 (720p) -- Free
- 1920x1080 (1080p) -- 서포터 전용
- 2560x1440 (1440p) -- 서포터 전용
- 3840x2160 (4K) -- 서포터 전용

**4:3**
- 640x480 (VGA) -- Free
- 960x720 -- Free
- 1024x768 (XGA) -- Free
- 1440x1080 -- 서포터 전용
- 1920x1440 -- 서포터 전용
- 2880x2160 -- 서포터 전용

**1:1**
- 480x480 -- Free
- 720x720 -- Free
- 1080x1080 -- 서포터 전용
- 1440x1440 -- 서포터 전용
- 2160x2160 -- 서포터 전용

**맞춤**을 선택하면 원하는 너비와 높이를 지정할 수 있습니다(플랜의 최대 해상도가 상한선).

> 해상도 변경은 플레이어를 다시 연결한 뒤에 반영됩니다.

### 이 앱에 대한 탭

애플리케이션 버전 정보와 사용 중인 오픈소스 소프트웨어의 라이선스 표기를 확인할 수 있습니다. 각 라이선스는 접이식 섹션에 표시됩니다.

표시되는 라이선스:

- **GStreamer** -- LGPL-2.1-or-later
- **Spout2 SDK** (Windows) -- BSD 2-Clause License
- **Syphon Framework** (macOS) -- BSD 3-Clause License
- **Rust Crate** (tokio, serde, egui등) -- MIT / Apache-2.0
- **Noto Sans JP** -- SIL Open Font License 1.1

---

## 플랜 비교

| 기능 | Free | Supporter |
| ------ | ------ | ----------- |
| 동시 사용 플레이어 수 | 2 | 4 |
| 최대 해상도 | 720p (1280x720) | 4K (3840x2160) |
| 해상도 프리셋 | 표준만 | 전체 프리셋 |

서포터 스테이터스는 KonaLab Discord 서버에서의 역할에 따라 판단됩니다. 유효 기간은 30일이며, 7일이 지나면 자동으로 재확인됩니다.

---

## VJ 소프트웨어에서의 활용

플레이어가 캡처 중인 경우, 영상은 Spout(Windows) 또는 Syphon(macOS)의 소스로 사용할 수 있습니다. 소스 이름은 다음과 같습니다.

- `GrabDuct Player 1`
- `GrabDuct Player 2`
- `GrabDuct Player 3`
- `GrabDuct Player 4`

### Resolume Arena / Avenue

1. **Sources** 탭을 연다
2. **Spout**(Windows) 또는 **Syphon**(macOS)를 선택
3. `GrabDuct Player N` 소스를 선택
4. 레이어/클립 슬롯으로 드래그

### OBS Studio

1. 새로운 **소스** 추가
2. **Spout2 Capture**(Windows) 또는 **Syphon Client**(macOS)를 선택하십시오
3. 드롭다운에서 `GrabDuct Player N`을 선택

### 기타 VJ 소프트웨어(VDMX, MadMapper 등)

Spout(Windows) 또는 Syphon(macOS) 입력을 지원하는 소프트웨어라면 GrabDuct 플레이어가 소스로 표시됩니다.

---

## 자동 재캡처

GrabDuct는 다음과 같은 상황에서 영상을 자동으로 재캡처합니다.

- SPA 네비게이션(페이지 전체 재로드 없이 동영상 간 이동 시)
- 페이지 내 동영상 요소 변경 시(DOM 변경)
- 단일 페이지 애플리케이션 내 네비게이션

재캡처는 500ms 디바운스로 제어되어 빈번한 재트리거를 방지합니다. 재캡처 중에도 플레이어 할당은 유지됩니다.

---

## 문제 해결

### 팝업에 “리시버 미연결”이 표시됨

- GrabDuct 리시버 프로그램이 실행 중인지 확인(시스템 트레이/메뉴 바 확인)
- 리시버는 `localhost:9876`에서 리스닝 중입니다. 방화벽이 로컬 연결을 차단하지 않는지 확인
- 리시버 프로그램을 재시작

macOS에서 앱이 열리지 않을 때

“개발자가 확인되지 않아 열 수 없습니다”라고 표시되거나, 더블 클릭해도 아무 반응이 없을 경우:

1. Finder에서 앱을 마우스 오른쪽 버튼으로 클릭 → **열기** 선택, 또는
2. 터미널에서 다음 명령어 실행:

```bash
xattr -cr /Applications/GrabDuct\ Receiver.app
```

자세한 내용은 「설정 > macOS > Gatekeeper 경고 처리」를 참조하십시오.

### VJ 소프트웨어에 영상이 표시되지 않음

- 설정 패널에서 플레이어 상태가 녹색(“수신 중”)인지 확인
- VJ 소프트웨어가 Spout/Syphon 소스를 스캔 중인지 확인
- 올바른 플레이어 이름(예: `GrabDuct Player 1`)이 선택되었는지 확인
- DRM 보호된 콘텐츠는 `captureStream()`으로 캡처할 수 없는 경우가 있습니다

### 「이 페이지에 동영상 요소가 없습니다」

- 페이지에 `<video>` 요소가 존재하고 재생이 시작되었는지 확인
- 동영상이 있는 페이지로 이동하여 로딩이 완료된 후 플레이어를 할당

### 플레이어가 「오류」 상태가 됨

- Chrome 개발자 도구 콘솔(F12)에서 `[GrabDuct]` 로그 메시지 확인
- 주요 원인: 영상 트랙 종료, WebRTC ICE 연결 실패, 페이지 이동
- 플레이어 할당 해제 후 재할당 시도

### 멤버십 만료 경고

- 설정 패널에서 Discord 멤버십 만료일이 임박한 경우(7일 미만) 경고가 표시됩니다
- **역할 재확인**을 클릭하여 멤버십 유효성 검증을 갱신
- 서버 멤버 자격이 해지된 경우, Discord 서버에 재가입하여 다시 로그인
---

## 설정 파일

리시버 프로그램의 설정 파일은 다음 위치에 저장됩니다.

- **Windows**: `%APPDATA%\GrabDuct\config.json`
- **macOS**: `~/Library/Application Support/GrabDuct/config.json`

이 파일에는 Discord 인증 토큰(난독화됨), 서포터 유효 기간, 플레이어별 해상도 설정이 포함됩니다. 첫 실행 시 자동으로 생성됩니다.

---

## 기술 정보

- 영상은 Chrome에서 리시버 프로그램으로 WebRTC를 통해 localhost 상에서 전송됩니다(외부 네트워크 통신 없음)
- WebSocket 시그널링 서버는 `127.0.0.1:9876`에서 작동(로컬 전용)
- 하드웨어 가속화를 위해 H.264 High Profile 우선 사용
- 로컬 연결 시 화질 극대화를 위해 비트레이트는 최대 50 Mbps로 설정
- GPU 텍스처 공유는 Direct3D 11 공유 텍스처(Windows) 또는 IOSurface(macOS)를 통한 제로 카피
- macOS 버전은 유니버설 바이너리(arm64 + x86_64) 지원
- 리시버 프로그램은 메뉴 바 앱으로 동작하며, Dock에 아이콘은 표시되지 않음(macOS)
- 음성 캡처 및 전송은 지원하지 않음
