# GrabDuct ユーザーガイド

## GrabDuctとは

GrabDuctは、Chromeブラウザのタブから映像をキャプチャし、GPUテクスチャとしてVJソフトウェア（Resolume、VDMX、OBSなど）に送信するツールです。Windows環境ではSpout、macOS環境ではSyphonを使用したゼロコピーGPUテクスチャ共有により、低遅延・高画質な映像ルーティングを実現します。

## 動作環境

| 項目 | 要件 |
|------|------|
| OS | Windows 10/11 または macOS |
| ブラウザ | Chrome / Chromium 116以上 |
| GPU | Direct3D 11対応（Windows）または Metal対応（macOS） |
| ランタイム | GStreamer（インストーラーに同梱） |

## 構成

GrabDuctは2つのコンポーネントで構成されています。

1. **Chrome拡張機能** -- ブラウザタブの映像をキャプチャし、プレイヤーに割り当てます。
2. **レシーバーアプリケーション** -- システムトレイで動作するネイティブアプリで、WebRTC経由で映像を受信し、Spout/Syphonテクスチャとして出力します。

映像キャプチャには両方が同時に起動している必要があります。

---

## セットアップ

### 1. レシーバーアプリケーションのインストール

GrabDuctのインストーラーを実行します。インストール後、レシーバーはシステムトレイ（通知領域）に常駐します。メインウィンドウはなく、トレイアイコンと設定パネルから操作します。

### 2. Chrome拡張機能のインストール

1. Chromeを開き、`chrome://extensions/` にアクセス
2. 右上の **デベロッパーモード** を有効にする
3. **パッケージ化されていない拡張機能を読み込む** をクリックし、`extension/` フォルダを選択
4. ツールバーにGrabDuctのアイコンが表示される

### 3. レシーバーの起動

GrabDuctレシーバーアプリケーションを起動します。システムトレイにアイコンが表示されます。トレイアイコンを右クリックすると以下のメニューが表示されます。

- **Settings** -- 設定パネルを開く
- **Quit** -- アプリケーションを終了する

### 4. Discord認証

GrabDuctの利用にはDiscordサーバーへの参加と認証が必要です。

1. トレイアイコンを右クリックし **Settings** を選択
2. ログイン画面で **Discordでログイン** をクリック
3. ブラウザでDiscordの認証ページが開く
4. アプリケーションを承認する
5. 認証が完了するとメイン画面が利用可能になる

---

## 基本的な使い方

### タブをプレイヤーに割り当てる

1. Chromeで映像コンテンツのあるページ（YouTube、Twitchなど）を開く
2. ツールバーのGrabDuct拡張機能アイコンをクリック
3. ポップアップに現在のタブ名と最大4つのプレイヤースロットが表示される
4. 「待機中」と表示されているプレイヤースロットをクリックして現在のタブを割り当てる

キャプチャが開始されるとステータスが緑色に変わります。

### プレイヤースロットの状態

| 表示 | ステータス | 意味 |
|------|-----------|------|
| グレーのドット | 待機中 | タブ未割り当て |
| 緑のドット | キャプチャ中 | 映像をキャプチャ・送信中 |
| 赤のドット | エラー | キャプチャ失敗（トラブルシューティング参照） |
| 鍵アイコン | サポーター専用 | サポータープランが必要 |

### タブの割り当て解除

「このタブ」と表示されているプレイヤースロットをクリックすると、現在のタブの割り当てが解除されます。

### プレイヤーの再割り当て

別のタブに割り当て済みのプレイヤーをクリックすると、確認ダイアログが表示されます。確認すると現在のタブに再割り当てされます。

### レシーバー接続状態

ポップアップ上部に接続状態が表示されます。

- **緑**（「レシーバー接続中」） -- レシーバーアプリが起動中で接続可能
- **赤**（「レシーバー未接続」） -- レシーバーアプリが起動していないか応答なし

拡張機能は5秒ごとに接続状態を確認します。

---

## レシーバーの設定

システムトレイアイコンから設定パネルを開きます。2つのタブがあります。

### ステータスタブ

以下の情報が表示されます。

- 現在のプラン（FreeまたはSupporter）とプレイヤー数・解像度の上限
- プレイヤーごとのステータスカード（接続状態と解像度）
- アクティブなプレイヤーのSpout/Syphon出力名（例: `GrabDuct Player 1`）
- エラー情報

### 設定タブ

#### Discord認証

- Discordユーザー名とメンバーシップの有効期限を表示
- **ロール再確認** -- Discordサーバーのメンバーシップとサポーターロールを手動で再確認
- **ログアウト** -- Discordからサインアウト（ログイン画面に戻る）

#### 出力解像度

プレイヤーごとに出力解像度を設定できます。プリセットはアスペクト比別に分類されています。

**16:9**
- 1280x720 (720p) -- Free
- 1920x1080 (1080p) -- Supporter限定
- 2560x1440 (1440p) -- Supporter限定
- 3840x2160 (4K) -- Supporter限定

**4:3**
- 640x480 (VGA) -- Free
- 960x720 -- Free
- 1024x768 (XGA) -- Free
- 1440x1080 -- Supporter限定
- 1920x1440 -- Supporter限定
- 2880x2160 -- Supporter限定

**1:1**
- 480x480 -- Free
- 720x720 -- Free
- 1080x1080 -- Supporter限定
- 1440x1440 -- Supporter限定
- 2160x2160 -- Supporter限定

**カスタム** を選択すると、任意の幅と高さを指定できます（プランの最大解像度が上限）。

> 解像度の変更はプレイヤーの再接続後に反映されます。

---

## プラン比較

| 機能 | Free | Supporter |
|------|------|-----------|
| 同時使用プレイヤー数 | 2 | 4 |
| 最大解像度 | 720p (1280x720) | 4K (3840x2160) |
| 解像度プリセット | 標準のみ | 全プリセット |

サポーターステータスはGrabDuct Discordサーバーでのロールによって判定されます。有効期間は30日間で、自動的に再確認されます。

---

## VJソフトウェアでの利用

プレイヤーがキャプチャ中の場合、映像はSpout（Windows）またはSyphon（macOS）のソースとして利用可能になります。ソース名は以下の通りです。

- `GrabDuct Player 1`
- `GrabDuct Player 2`
- `GrabDuct Player 3`
- `GrabDuct Player 4`

### Resolume Arena / Avenue

1. **Sources** タブを開く
2. **Spout**（Windows）または **Syphon**（macOS）を選択
3. `GrabDuct Player N` ソースを選択
4. レイヤー/クリップスロットにドラッグ

### OBS Studio

1. 新しい **ソース** を追加
2. **Spout2 Capture**（Windows）または **Syphon Client**（macOS）を選択
3. ドロップダウンから `GrabDuct Player N` を選択

### その他のVJソフトウェア（VDMX、MadMapperなど）

Spout（Windows）またはSyphon（macOS）入力に対応しているソフトウェアであれば、GrabDuctのプレイヤーがソースとして表示されます。

---

## 自動再キャプチャ

GrabDuctは以下の状況で映像を自動的に再キャプチャします。

- YouTubeのSPAナビゲーション（ページ全体のリロードなしに動画間を移動した場合）
- ページ内の動画要素が変更された場合（DOM変更）
- シングルページアプリケーション内でのナビゲーション

再キャプチャは500msのデバウンスで制御され、頻繁な再トリガーを防止します。再キャプチャ中もプレイヤーの割り当ては維持されます。

---

## トラブルシューティング

### ポップアップに「レシーバー未接続」と表示される

- GrabDuctレシーバーアプリケーションが起動していることを確認（システムトレイを確認）
- レシーバーは `localhost:9876` でリッスンしています。ファイアウォールがローカル接続をブロックしていないか確認
- レシーバーアプリケーションを再起動

### VJソフトウェアに映像が表示されない

- 設定パネルでプレイヤーのステータスが緑色（「受信中」）になっていることを確認
- VJソフトウェアがSpout/Syphonソースをスキャンしているか確認
- 正しいプレイヤー名（例: `GrabDuct Player 1`）が選択されているか確認
- DRM保護されたコンテンツは `captureStream()` でキャプチャできない場合があります

### 「このページに動画要素が見つかりません」

- ページに `<video>` 要素が存在し、再生が開始されていることを確認
- 動画のあるページに移動し、読み込みが完了してからプレイヤーを割り当てる

### プレイヤーが「エラー」状態になる

- ChromeのDevToolsコンソール（F12）で `[GrabDuct]` のログメッセージを確認
- 主な原因: 映像トラックの終了、WebRTC ICE接続の失敗、ページ遷移
- プレイヤーの割り当てを解除し、再度割り当てを試す

### メンバーシップ有効期限の警告

- 設定パネルでDiscordメンバーシップの有効期限が近い場合（残り7日未満）に警告が表示されます
- **ロール再確認** をクリックしてメンバーシップの検証を更新
- サーバーメンバーでなくなった場合は、Discordサーバーに再参加してログインし直す

---

## 設定ファイル

レシーバーの設定ファイルは以下の場所に保存されます。

- **Windows**: `%APPDATA%\GrabDuct\config.json`
- **macOS**: `~/Library/Application Support/GrabDuct/config.json`

このファイルにはDiscord認証トークン（難読化済み）、サポーター有効期限、プレイヤーごとの解像度設定が含まれます。初回起動時に自動的に作成されます。

---

## 技術情報

- 映像はChromeからレシーバーへWebRTC経由でlocalhost上で送信されます（外部ネットワーク通信なし）
- WebSocketシグナリングサーバーは `127.0.0.1:9876` で動作（ローカルのみ）
- ハードウェアアクセラレーションのため H.264 High Profileを優先使用
- ローカル接続での画質を最大化するため、ビットレートは最大50 Mbpsに設定
- GPUテクスチャ共有はDirect3D 11共有テクスチャ（Windows）またはIOSurface（macOS）によるゼロコピー
- 音声のキャプチャ・送信には対応していません
