# GrabDuct ユーザーガイド

## GrabDuctとは

GrabDuctは、Chromeブラウザのタブから映像をキャプチャし、GPUテクスチャとしてVJソフトウェア（Resolume、VDMX、OBSなど）に送信するツールです。Windows環境ではSpout、macOS環境ではSyphonを使用したゼロコピーGPUテクスチャ共有により、低遅延・高画質な映像ルーティングを実現します。

## バージョン

| コンポーネント | バージョン |
|---------------|-----------|
| Chrome拡張機能 | 0.2.2 |
| レシーバーアプリ | 0.2.1 |

## 動作環境

| 項目 | Windows | macOS |
|------|---------|-------|
| OS | Windows 10/11 | macOS 13 (Ventura) 以上 |
| ブラウザ | Chrome / Chromium 116以上 | Chrome / Chromium 116以上 |
| GPU | Direct3D 11対応 | Metal対応 |
| テクスチャ出力 | Spout | Syphon |
| ランタイム | GStreamer（インストーラーに同梱） | GStreamer（.appに同梱） |

## 構成

GrabDuctは2つのコンポーネントで構成されています。

1. **Chrome拡張機能** -- ブラウザタブの映像をキャプチャし、プレイヤーに割り当てます。
2. **レシーバーアプリケーション** -- システムトレイ/メニューバーで動作するネイティブアプリで、WebRTC経由で映像を受信し、Spout/Syphonテクスチャとして出力します。

映像キャプチャには両方が同時に起動している必要があります。

---

## セットアップ

### 1. レシーバーアプリケーションのインストール

#### Windows

GrabDuctのインストーラー（`GrabDuctReceiverSetup.exe`）を実行します。インストール後、レシーバーはシステムトレイ（通知領域）に常駐します。

#### macOS

DMGファイル（`GrabDuctReceiver.dmg`）を開き、`GrabDuct Receiver.app` をApplicationsフォルダにドラッグします。

**Gatekeeper警告への対処（未署名ビルドの場合）:**

macOSでは未署名のアプリを開こうとすると「開発元が未確認のため開けません」という警告が表示されることがあります。以下のいずれかの方法で対処してください。

**方法1: 右クリックから開く**

1. Finderで `GrabDuct Receiver.app` を右クリック（またはControlキー+クリック）
2. メニューから **開く** を選択
3. 確認ダイアログで **開く** をクリック

この操作は初回のみ必要です。以降は通常通りダブルクリックで起動できます。

**方法2: xattrコマンドで隔離属性を削除**

ターミナルで以下のコマンドを実行します:

```bash
xattr -cr /Applications/GrabDuct\ Receiver.app
```

`xattr -cr` は、macOSがダウンロードしたファイルに付与する隔離属性（`com.apple.quarantine`）を再帰的に削除します。これにより、Gatekeeperによるブロックが解除されます。

> `-c` はすべての拡張属性を削除、`-r` はディレクトリ内を再帰的に処理するオプションです。

### 2. Chrome拡張機能のインストール

**ZIPパッケージからインストールする場合:**

1. 配布された `grabduct-extension-vX.Y.Z.zip` を任意のフォルダに展開
2. Chromeで `chrome://extensions/` にアクセス
3. 右上の **デベロッパーモード** を有効にする
4. **パッケージ化されていない拡張機能を読み込む** をクリックし、展開したフォルダを選択
5. ツールバーにGrabDuctのアイコンが表示される

**ソースから直接ロードする場合:**

上記の手順4で `extension/` フォルダを選択します。

### 3. レシーバーの起動

GrabDuctレシーバーアプリケーションを起動します。

- **Windows**: システムトレイにアイコンが表示されます。右クリックでメニューを開きます。
- **macOS**: メニューバーにアイコンが表示されます。クリックでメニューを開きます。Dockにはアイコンは表示されません。

メニュー項目:

- **Settings** -- 設定パネルを開く
- **Quit** -- アプリケーションを終了する

### 4. Discord認証

GrabDuctの利用にはKonaLab Discordサーバーへの参加と認証が必要です。

1. メニューから **Settings** を選択
2. ログイン画面で **Discordでログイン** をクリック
3. ブラウザでDiscordの認証ページが開く
4. アプリケーションを承認する
5. 認証が完了するとメイン画面が利用可能になる

---

## 基本的な使い方

### タブをプレイヤーに割り当てる

1. Chromeで映像コンテンツのあるページを開く
2. ツールバーのGrabDuct拡張機能アイコンをクリック
3. ポップアップに現在のタブ名と最大4つのプレイヤースロットが表示される
4. 「待機中」と表示されているプレイヤースロットをクリックして現在のタブを割り当てる

キャプチャが開始されるとステータスが緑色に変わります。

### プレイヤースロットの状態

| 表示 | ステータス | 意味 |
|------|-----------|------|
| グレーのドット | 待機中 | タブ未割り当て |
| 緑のドット | キャプチャ中 | 映像をキャプチャ・送信中 |
| 赤のドット | エラー | キャプチャ失敗（トラブルシューティング参照） |
| 鍵アイコン | サポーター専用 | サポータープランが必要 |

### タブの割り当て解除

「このタブ」と表示されているプレイヤースロットをクリックすると、現在のタブの割り当てが解除されます。

### プレイヤーの再割り当て

別のタブに割り当て済みのプレイヤーをクリックすると、確認ダイアログが表示されます。確認すると現在のタブに再割り当てされます。

### レシーバー接続状態

ポップアップ上部に接続状態が表示されます。

- **緑**（「レシーバー接続中」） -- レシーバーアプリが起動中で接続可能
- **赤**（「レシーバー未接続」） -- レシーバーアプリが起動していないか応答なし

拡張機能は5秒ごとに接続状態を確認します。

---

## レシーバーの設定

メニューから設定パネルを開きます。3つのタブがあります。

### ステータスタブ

以下の情報が表示されます。

- 現在のプラン（FreeまたはSupporter）とプレイヤー数・解像度の上限
- プレイヤーごとのステータスカード（接続状態と解像度）
- アクティブなプレイヤーのSpout/Syphon出力名（例: `GrabDuct Player 1`）
- エラー情報

### 設定タブ

#### Discord認証

- Discordユーザー名とメンバーシップの有効期限を表示
- **ロール再確認** -- Discordサーバーのメンバーシップとサポーターロールを手動で再確認
- **ログアウト** -- Discordからサインアウト（ログイン画面に戻る）

#### 出力解像度

プレイヤーごとに出力解像度を設定できます。プリセットはアスペクト比別に分類されています。

**16:9**
- 1280x720 (720p) -- Free
- 1920x1080 (1080p) -- Supporter限定
- 2560x1440 (1440p) -- Supporter限定
- 3840x2160 (4K) -- Supporter限定

**4:3**
- 640x480 (VGA) -- Free
- 960x720 -- Free
- 1024x768 (XGA) -- Free
- 1440x1080 -- Supporter限定
- 1920x1440 -- Supporter限定
- 2880x2160 -- Supporter限定

**1:1**
- 480x480 -- Free
- 720x720 -- Free
- 1080x1080 -- Supporter限定
- 1440x1440 -- Supporter限定
- 2160x2160 -- Supporter限定

**カスタム** を選択すると、任意の幅と高さを指定できます（プランの最大解像度が上限）。

> 解像度の変更はプレイヤーの再接続後に反映されます。

### このアプリについてタブ

アプリケーションのバージョン情報と、使用しているオープンソースソフトウェアのライセンス表記を確認できます。各ライセンスは折りたたみ式のセクションで表示されます。

表示されるライセンス:

- **GStreamer** -- LGPL-2.1-or-later
- **Spout2 SDK** (Windows) -- BSD 2-Clause License
- **Syphon Framework** (macOS) -- BSD 3-Clause License
- **Rustクレート** (tokio, serde, egui等) -- MIT / Apache-2.0
- **Noto Sans JP** -- SIL Open Font License 1.1

---

## プラン比較

| 機能 | Free | Supporter |
|------|------|-----------|
| 同時使用プレイヤー数 | 2 | 4 |
| 最大解像度 | 720p (1280x720) | 4K (3840x2160) |
| 解像度プリセット | 標準のみ | 全プリセット |

サポーターステータスはKonaLab Discordサーバーでのロールによって判定されます。有効期間は30日間で、7日間を切ると自動的に再確認されます。

---

## VJソフトウェアでの利用

プレイヤーがキャプチャ中の場合、映像はSpout（Windows）またはSyphon（macOS）のソースとして利用可能になります。ソース名は以下の通りです。

- `GrabDuct Player 1`
- `GrabDuct Player 2`
- `GrabDuct Player 3`
- `GrabDuct Player 4`

### Resolume Arena / Avenue

1. **Sources** タブを開く
2. **Spout**（Windows）または **Syphon**（macOS）を選択
3. `GrabDuct Player N` ソースを選択
4. レイヤー/クリップスロットにドラッグ

### OBS Studio

1. 新しい **ソース** を追加
2. **Spout2 Capture**（Windows）または **Syphon Client**（macOS）を選択
3. ドロップダウンから `GrabDuct Player N` を選択

### その他のVJソフトウェア（VDMX、MadMapperなど）

Spout（Windows）またはSyphon（macOS）入力に対応しているソフトウェアであれば、GrabDuctのプレイヤーがソースとして表示されます。

---

## 自動再キャプチャ

GrabDuctは以下の状況で映像を自動的に再キャプチャします。

- SPAナビゲーション（ページ全体のリロードなしに動画間を移動した場合）
- ページ内の動画要素が変更された場合（DOM変更）
- シングルページアプリケーション内でのナビゲーション

再キャプチャは500msのデバウンスで制御され、頻繁な再トリガーを防止します。再キャプチャ中もプレイヤーの割り当ては維持されます。

---

## トラブルシューティング

### ポップアップに「レシーバー未接続」と表示される

- GrabDuctレシーバーアプリケーションが起動していることを確認（システムトレイ/メニューバーを確認）
- レシーバーは `localhost:9876` でリッスンしています。ファイアウォールがローカル接続をブロックしていないか確認
- レシーバーアプリケーションを再起動

### macOSでアプリが開けない

「開発元が未確認のため開けません」と表示される場合や、ダブルクリックしても何も反応がない場合:

1. Finderでアプリを右クリック → **開く** を選択、または
2. ターミナルで以下を実行:

```bash
xattr -cr /Applications/GrabDuct\ Receiver.app
```

詳しくは「セットアップ > macOS > Gatekeeper警告への対処」を参照してください。

### VJソフトウェアに映像が表示されない

- 設定パネルでプレイヤーのステータスが緑色（「受信中」）になっていることを確認
- VJソフトウェアがSpout/Syphonソースをスキャンしているか確認
- 正しいプレイヤー名（例: `GrabDuct Player 1`）が選択されているか確認
- DRM保護されたコンテンツは `captureStream()` でキャプチャできない場合があります

### 「このページに動画要素が見つかりません」

- ページに `<video>` 要素が存在し、再生が開始されていることを確認
- 動画のあるページに移動し、読み込みが完了してからプレイヤーを割り当てる

### プレイヤーが「エラー」状態になる

- ChromeのDevToolsコンソール（F12）で `[GrabDuct]` のログメッセージを確認
- 主な原因: 映像トラックの終了、WebRTC ICE接続の失敗、ページ遷移
- プレイヤーの割り当てを解除し、再度割り当てを試す

### メンバーシップ有効期限の警告

- 設定パネルでDiscordメンバーシップの有効期限が近い場合（残り7日未満）に警告が表示されます
- **ロール再確認** をクリックしてメンバーシップの検証を更新
- サーバーメンバーでなくなった場合は、Discordサーバーに再参加してログインし直す

---

## 設定ファイル

レシーバーの設定ファイルは以下の場所に保存されます。

- **Windows**: `%APPDATA%\GrabDuct\config.json`
- **macOS**: `~/Library/Application Support/GrabDuct/config.json`

このファイルにはDiscord認証トークン（難読化済み）、サポーター有効期限、プレイヤーごとの解像度設定が含まれます。初回起動時に自動的に作成されます。

---

## 技術情報

- 映像はChromeからレシーバーへWebRTC経由でlocalhost上で送信されます（外部ネットワーク通信なし）
- WebSocketシグナリングサーバーは `127.0.0.1:9876` で動作（ローカルのみ）
- ハードウェアアクセラレーションのため H.264 High Profileを優先使用
- ローカル接続での画質を最大化するため、ビットレートは最大50 Mbpsに設定
- GPUテクスチャ共有はDirect3D 11共有テクスチャ（Windows）またはIOSurface（macOS）によるゼロコピー
- macOS版はUniversal Binary（arm64 + x86_64）に対応
- レシーバーはメニューバーアプリとして動作し、Dockにアイコンは表示されません（macOS）
- 音声のキャプチャ・送信には対応していません

---

